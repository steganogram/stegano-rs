name: Release
on:
  push:
    tags:
      - "*-v[0-9]+.[0-9]+.[0-9]+"
      - "*-v[0-9]+.[0-9]+.[0-9]-alpha.[0-9]+"
      - "*-v[0-9]+.[0-9]+.[0-9]-beta.[0-9]+"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (must be a package-specific tag like stegano-cli-v0.6.1)"
        required: true
        default: ""

jobs:
  doing-a-build:
    needs: determine-crate
    runs-on: ubuntu-latest
    env:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
    steps:
      - name: Checkout release tag for build
        uses: actions/checkout@v6
        with:
          submodules: "recursive"
          fetch-depth: 0
          ref: refs/tags/${{ needs.determine-crate.outputs.tag }}
      - name: setup | rust
        uses: dtolnay/rust-toolchain@stable
      - name: cargo build
        run: cargo build --workspace --verbose
      - name: cargo test
        run: cargo test --workspace --verbose

  determine-crate:
    name: Determine crate and version from tag
    runs-on: ubuntu-latest
    outputs:
      crate: ${{ steps.parse.outputs.crate }}
      version: ${{ steps.parse.outputs.version }}
      tag: ${{ steps.parse.outputs.tag }}
    steps:
      - name: Checkout (fetch tags)
        uses: actions/checkout@v6
        with:
          submodules: "recursive"
          # Fetch tags so we can checkout the tagged ref later
          fetch-depth: 0

      - id: parse
        name: Parse tag and validate crate
        shell: bash
        run: |
          set -euo pipefail

          # Choose tag source:
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            # For push on tag events
            if [ -n "${GITHUB_REF:-}" ] && [[ "${GITHUB_REF}" =~ ^refs/tags/(.*)$ ]]; then
              TAG="${BASH_REMATCH[1]}"
            else
              echo "Could not determine tag from event. Provide a tag when dispatching."
              exit 1
            fi
          fi

          echo "Resolved tag: ${TAG}"

          # Ensure the tag exists locally and check it out so validation matches the released source
          # Fetch tags from origin and try to checkout the tag ref.
          git fetch --prune --tags origin || true

          # Try to checkout the annotated/tag ref directly; fall back to tag name
          if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            git checkout -f "refs/tags/${TAG}"
          else
            # attempt shallow fetch of the specific tag and checkout by tag name
            git fetch --depth=1 origin "refs/tags/${TAG}:refs/tags/${TAG}" || true
            git checkout -f "${TAG}" || true
          fi

          # After checking out the tag, confirm the working tree matches the requested tag
          CURRENT_TAG=$(git describe --tags --exact-match 2>/dev/null || true)
          if [ -n "${CURRENT_TAG}" ]; then
            echo "Checked out tag: ${CURRENT_TAG}"
          else
            # best-effort warning but continue; subsequent validations will fail if files missing
            echo "Warning: could not verify that the tag was checked out exactly. Proceeding with repository state."
          fi

          # Expect tags of the form <crate>-v<version>, e.g. stegano-cli-v0.6.1
          if [[ "${TAG}" =~ ^(.+)-v(.+)$ ]]; then
            CRATE="${BASH_REMATCH[1]}"
            VERSION="${BASH_REMATCH[2]}"
          else
            echo "Invalid tag format. This workflow only accepts crate-specific tags of the form <crate>-vX.Y.Z (e.g. stegano-cli-v0.6.1)."
            exit 1
          fi

          # Validate crate directory exists (now using the checked-out tag)
          if [ ! -f "crates/${CRATE}/Cargo.toml" ]; then
            echo "Crate 'crates/${CRATE}' does not exist in the repository at tag ${TAG}."
            exit 1
          fi

          # Export outputs
          echo "crate=${CRATE}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

  publish:
    name: cargo publish
    needs: [doing-a-build, determine-crate]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout release tag
        uses: actions/checkout@v6
        with:
          submodules: "recursive"
          fetch-depth: 0
          ref: refs/tags/${{ needs.determine-crate.outputs.tag }}
      - name: setup | rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish crate
        shell: bash
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          CRATE="${{ needs.determine-crate.outputs.crate }}"
          VERSION="${{ needs.determine-crate.outputs.version }}"
          echo "Publishing crate: ${CRATE} version: ${VERSION}"
          cargo publish --manifest-path crates/${CRATE}/Cargo.toml

  release:
    name: Create GitHub Release
    needs: publish
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: "recursive"
          ref: ${{ needs.determine-crate.outputs.tag }}
      - name: setup | rust
        uses: dtolnay/rust-toolchain@stable

      - name: Resolve version and tag
        id: tag_info
        shell: bash
        run: |
          TAG="${{ needs.determine-crate.outputs.tag }}"
          VERSION="${{ needs.determine-crate.outputs.version }}"
          echo "current_version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "release_tag=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Get Changelog Entry
        id: changelog_reader
        uses: mindsers/changelog-reader-action@v2
        with:
          validation_depth: 10
          version: ${{ steps.tag_info.outputs.current_version }}
          path: crates/${{ needs.determine-crate.outputs.crate }}/CHANGELOG.md

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        with:
          tag_name: ${{ steps.tag_info.outputs.release_tag }}
          release_name: ${{ needs.determine-crate.outputs.crate }} v${{ steps.tag_info.outputs.current_version }}
          body: ${{ steps.changelog_reader.outputs.changes }}
          prerelease: ${{ steps.changelog_reader.outputs.status == 'prereleased' }}
          draft: ${{ steps.changelog_reader.outputs.status == 'unreleased' }}
